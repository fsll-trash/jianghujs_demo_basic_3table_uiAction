{% extends 'template/jhTemplate.html'%}

<!-- vue template 代码块 -->
{% block vue_template %}
<jh-layout>
    <v-container class="fullScreen d-flex flex-column pa-xs-0 pa-0">
        <v-row class="ma-0 pa-xs-4 align-center flex-none pt-0 "
               :class="{'pa-4': !isMobile, 'pb-0': !isMobile, 'pa-2': isMobile}">
            <v-col cols="12" class="pa-xs-0 pb-xs-4 pb-0">
                <h2>
                    【{{ title }}】的学生管理
                    <span style="font-size: 1rem;" :class="{'d-block': isMobile}">(ID: {{ classId }})</span>
                </h2>
            </v-col>
        </v-row>
        <v-divider></v-divider>
        <v-row class="ma-0 pa-xs-4 align-center flex-none pt-0 "
               :class="{'pa-4': !isMobile, 'pb-0': !isMobile, 'pa-2': isMobile}">
            <v-col cols="12" xs="4" sm="4" md="4" xl="4" class="pl-0 ">
                <v-btn small dark color="success" @click="isEditDrawerShow = true" class="elevation-0 mr-2">分配新学生
                </v-btn>
                <span class="body-2">共{{ tableData.length }}条记录</span>
            </v-col>
            <v-spacer></v-spacer>
            <v-col cols="12" xs="8" sm="4" md="3" xl="3" class="pa-xs-0 pa-xs-2 col-sm-8-flex">
                <v-text-field dense outlined v-model="searchInput" label="表格过滤" class="cus-v-input"></v-text-field>
            </v-col>
        </v-row>
        <v-data-table
                fixed-header
                :headers="headers"
                :items="tableData"
                :search="searchInput"
                :footer-props="{ itemsPerPageOptions: [20, 40, 60, 100, -1] }"
                :items-per-page="-1"
                :loading="isTableLoading"
                :dense="isMobile"
                mobile-breakpoint="0"
                class="elevation-0 mt-0 mb-xs-4 flex-fill d-flex flex-column"
        >
            <template v-slot:item.gender="{ item }">
                {{ (constantCollection.gender.find(({value}) => value === item.gender) || {}).text }}
            </template>
            <template v-slot:item.operationAt="{ item }">
                {{ item.operationAt && dayjs(item.operationAt).format('YYYY-MM-DD HH:mm:ss') }}
            </template>
            <template v-slot:item.option="{ item }">
                <v-btn :small="!isMobile" :xSmall="isMobile" :class="btn.color" v-for="btn of tableButtonList"
                       @click="doUiAction('deleteItem', {item})" :key="btn.value">
                    {{ btn.text }}
                </v-btn>
            </template>
        </v-data-table>
        <v-navigation-drawer
                v-model="isEditDrawerShow"
                :permanent="isEditDrawerPermanent"
                absolute
                temporary
                right
                touchless
                width="80%"
                :dense="isMobile"
                hide-overlay
                class="elevation-24"
        >
            <v-container class="navDrawerContainer">
                <v-row class=" pa-2">
                    <v-btn class="mt-0" small dark color="success" elevation="0" @click="doUiAction('allotStudent')">新增</v-btn>
                    <v-spacer></v-spacer>
                    <v-btn class="mr-4 mt-1 elevation-0" fab x-small @click="isEditDrawerShow = false">
                        <v-icon dark>mdi-close</v-icon>
                    </v-btn>
                </v-row>
                <v-row class="pa-2 py-0">
                    <v-data-table
                            fixed-header
                            show-select
                            checkbox-color="success"
                            :headers="headers"
                            :loading="isDrawerTableLoading"
                            :items="drawerTableData"
                            item-key="studentId"
                            :dense="isMobile"
                            :footer-props="{ itemsPerPageOptions: [20, 40, 60, 100, -1] }"
                            :items-per-page="-1"
                            mobile-breakpoint="0"
                            @item-selected="drawerItemSelected"
                            @toggle-select-all="drawerToggleSelectAll"
                            class="elevation-0 pt-0 mb-xs-4 flex-fill d-flex flex-column show-select"
                    >
                        <template v-slot:item.gender="{ item }">
                            {{ getConstantCollectionItemText('gender', item.gender) }}
                        </template>
                        <template v-slot:item.option="{ item }">
                            <v-btn :small="!isMobile" :xSmall="isMobile" class="success" @click="doUiAction('buildRelation', {item})">
                                新增
                            </v-btn>
                        </template>
                    </v-data-table>
                </v-row>
            </v-container>
        </v-navigation-drawer>
    </v-container>

</jh-layout>
{% endblock %}

{% block vue_body %}
{% include 'layout/jhLayout.html' %}
{% include 'common/resetTableMaxHeight.html' %}
<script type="module">

  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    mixins: [window.jianghuUiActionMixins],
    data: {
      classId: null,
      title: null,

      searchInput: null,
      isTableLoading: true,
      isDrawerTableLoading: true,
      isEditDrawerPermanent: false,
      isEditDrawerShow: false,
      constantCollection: {
        gender: [{"value": "male", "text": "男"}, {"value": "female", "text": "女"}],
      },
      headers: [
        {text: "学生ID", value: "studentId", width: 120, required: true, class: 'fixed', cellClass: 'fixed'},
        {text: "学生名字", value: "name", width: 120, required: true},
        {text: "性别", value: "gender", width: 120},
        {text: "出生日期", value: "dateOfBirth", type: "date", width: 120},
        {text: "身高", value: "bodyHeight", width: 120},
        {text: "学生状态", value: "studentStatus", width: 120},
        {text: "备注", value: "remarks", width: 120},
        {text: "操作人", value: "operationByUser", width: 120},
        {text: "操作时间", value: "operationAt", width: 250},
        {text: '操作', value: 'option', align: 'center', sortable: false, width: 200, class: 'fixed', cellClass: 'fixed'},
      ],
      drawerTableDataFromBackend: [],
      tableDataFromBackend: [],
      tableButtonList: [
        {text: '删除', buttonType: 'delete', color: 'error',},
      ],
      drawerItemSelectedClass: [],
      currentClickButton: {title: '新增', action: 'add'},
    },
    computed: {
      isMobile() {
        return window.innerWidth < 600;
      },
      tableData() {
        return this.tableDataFromBackend;
      },
      drawerTableData() {
        if (_.isEmpty(this.drawerTableDataFromBackend)) {
          return [];
        }
        return _.differenceBy(this.drawerTableDataFromBackend, this.tableData, 'studentId');
      },
    },
    watch: {},
    async created() {
      const urlParams = new URLSearchParams(location.search);
      const id = urlParams.get('id');
      const title = urlParams.get('title');
      if (id && title) {
        this.classId = id;
        this.title = title;
      } else {
        window.vtoast.fail('请从"班级列表"点击"学生"进入');
        return;
      }
    },
    mounted() {
      this.doUiAction('refreshTableData');
      this.doUiAction('getDrawerTableData');
    },
    methods: {
      async refreshTableData() {
        this.isTableLoading = true;
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'studentManagementOfOneClass',
              actionId: 'selectItemList',
              actionData: {},
              where: {
                classId: this.classId
              },
              orderBy: [{column: 'operationAt', order: 'desc'}]
            }
          }
        });
        this.tableDataFromBackend = result.data.appData.rows;
        this.isTableLoading = false;
      },
      // 未包含数据列表
      async getDrawerTableData() {
        this.isDrawerTableLoading = true;
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'studentManagementOfOneClass',
              actionId: 'selectStudentItemList',
              orderBy: [{column: 'operationAt', order: 'desc'}]
            }
          }
        });
        this.drawerTableDataFromBackend = result.data.appData.rows;
        this.isDrawerTableLoading = false;
      },

      async openDrawerDialog() {
        this.isEditDrawerPermanent = true;
      },

      async closeDrawerShow() {
        this.isEditDrawerPermanent = false;
      },

      // allotStudent
      async confirmAllotStudentDialog() {
        this.isEditDrawerPermanent = true;
        return window.confirmDialog({title: '确定将学生分配给此班级', content: '确定分配吗？'})
      },
      async doAllotStudent() {
        for (let i = 0; i < this.drawerItemSelectedClass.length; i++) {
          this.isEditDrawerPermanent = false;
          window.vtoast.loading(`正在新增 第${i + 1}个`);
          const {studentId} = this.drawerItemSelectedClass[i];
          await this.buildRelationImpl(studentId);
        }
        window.vtoast.success("批量新增成功");
      },

      async clearItemSelectedClass() {
        this.drawerItemSelectedClass = [];
      },

      // buildRelation
      async doBuildRelation({item}) {
        this.isEditDrawerPermanent = false;
        window.vtoast.loading("正在新增");
        await this.buildRelationImpl(item.studentId);
        window.vtoast.success("新增成功");
      },

      async buildRelationImpl(studentId) {
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'studentManagementOfOneClass',
              actionId: 'insertItem',
              actionData: {
                studentId, classId: this.classId
              }
            }
          }
        });
      },

      // deleteItem
      async confirmDeleteStudentForClassDialog() {
        return window.confirmDialog({title: '确认将学生从班级删除', content: '确定删除吗？'})
      },

      async doDeleteItem({item}) {
        window.vtoast.loading("删除中");
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'studentManagementOfOneClass',
              actionId: 'deleteItem',
              actionData: {},
              where: {id: item.id}
            }
          }
        });
        window.vtoast.success("删除成功");
      },
      drawerItemSelected({item, value}) {
        console.log(item, value);
        if (value) {
          this.drawerItemSelectedClass.push(item);
        } else {
          this.drawerItemSelectedClass = _.filter(this.drawerItemSelectedClass, ['studentId', item.studentId]);
        }
      },
      drawerToggleSelectAll({items, value}) {
        console.log(items, value);
        if (value) {
          this.drawerItemSelectedClass = items;
        } else {
          this.drawerItemSelectedClass = [];
        }
      },
      dayjs: dayjs,
      getConstantCollectionItemText(key, _value) {
        const constantCollectionItemFind = this.constantCollection[key].find(({value}) => value === _value);
        if (constantCollectionItemFind) {
          return constantCollectionItemFind.text;
        }
        return _value;
      }
    }
  })
</script>
{% endblock %}
